<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>Products</title>
        <link rel="stylesheet" href="style.css">

    <script>
        let allProducts = [];

        async function fetchProducts() {
            const categoryId = new URLSearchParams(window.location.search).get('categoryId');
            console.log("Category ID:", categoryId);
            if (!categoryId) return;

            const results = document.getElementById("results");
            results.innerHTML = "Loading...";

            const response = await fetch(`/search?categoryId=${categoryId}`);
            const products = await response.json();

            allProducts = products;     // store once
            displayProducts(allProducts);
        }

        function displayProducts(products) {
            const results = document.getElementById("results");
            results.innerHTML = "";
            console.log("Products from backend:", products);
            if (products.length === 0) {
                results.innerHTML = "<p>No products found</p>";
                return;
            }

            const favorites = getFavorites();

            products.forEach(p => {
                const isFav = favorites.includes(p.productId);

                const div = document.createElement("div");
                div.className = "card";
                div.innerHTML = `
                    <h3>${p.productName}</h3>
                    <p class="price">Rs ${p.cost}</p>

                    <button class="fav-btn" onclick="toggleFavorite(${p.productId})">
                        ${isFav ? "‚ù§Ô∏è" : "ü§ç"}
                    </button>

                    <a href="${p.productURL}" target="_blank">
                        <button class="small-btn">View Product</button>
                    </a>
                `;
                results.appendChild(div);
            });
        }

        function applyFilters() {
            const searchValue = document.getElementById("searchInput").value.toLowerCase();
            const min = document.getElementById("minPrice").value;
            const max = document.getElementById("maxPrice").value;
            const sortBy = document.getElementById("sortSelect").value;

            const filtered = allProducts.filter(p => {
                const matchesName = p.productName.toLowerCase().includes(searchValue);
                const matchesMin = !min || p.cost >= min;
                const matchesMax = !max || p.cost <= max;

                return matchesName && matchesMin && matchesMax;
            });

            if (sortBy === "price") {
                filtered.sort((a, b) => a.cost - b.cost);
            }

            if (sortBy === "name") {
                filtered.sort((a, b) => a.productName.localeCompare(b.productName));
            }
            
            displayProducts(filtered);
         }

        function getFavorites() {
            return JSON.parse(localStorage.getItem("favorites")) || [];
        }


        function showFavorites() {
            const favIds = getFavorites();   // reuse existing method
            const favProducts = allProducts.filter(p => favIds.includes(p.productId));
            displayProducts(favProducts);
        }


        function toggleFavorite(productId) {
            let favorites = getFavorites();

            if (favorites.includes(productId)) {
                favorites = favorites.filter(id => id !== productId);
            } else {
                favorites.push(productId);
            }

            localStorage.setItem("favorites", JSON.stringify(favorites));
            applyFilters(); // re-render products to update ‚ù§Ô∏è
        }

        window.onload = fetchProducts;
    </script>

    </head>

    <body>

        <header>
            <h1>Products</h1>
        </header>

        <div style="margin-bottom:20px;">
            <strong>Search:</strong>
            <input
                type="text"
                id="searchInput"
                placeholder="Search products..."
                onkeyup="applyFilters()"
                style="width:400px; padding:10px; margin-left:10px;"
            />
        </div>

        <div style="margin-bottom:20px;">
            <strong>Filter:</strong>

            <input
                type="number"
                id="minPrice"
                placeholder="Min price"
                oninput="applyFilters()"
                style="width:140px; padding:8px; margin-left:10px;"
            />

            <input
                type="number"
                id="maxPrice"
                placeholder="Max price"
                oninput="applyFilters()"
                style="width:140px; padding:8px; margin-left:10px;"
            />
        </div>

        <div style="margin-bottom:20px;">
            <strong>Sort:</strong>

            <select id="sortSelect" onchange="applyFilters()" style="padding:8px; margin-left:10px;">
                <option value="">Select</option>
                <option value="price">Price: Low to High</option>
                <option value="name">Name: A to Z</option>
            </select>
        </div>


        <button onclick="showFavorites()" class="small-btn">‚ù§Ô∏è Show Favorites</button>

        <div class="container">
            <div id="results" class="grid"></div>
        </div>

    </body>
</html>

